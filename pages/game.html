<main>
  <div class="container vertical_center">
    <div class="pageAlert" style="position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); padding:3rem; border-radius:2rem; background:rgba(0,0,0,.35);"><p style="font-size:2rem; font-weight:bold;">게임에 로그인 중</p></div>
    <canvas id="game" width="1280" height="720" style="background-color:#333;"></canvas>
    <script>
      function pageAlert(str){
        $('.pageAlert').addClass('on');
        $('.pageAlert p').text(str);
      }
      pageAlert('게임에 로그인 중');
      function login(){
        $.ajax({
          type:"POST",
          url:'/game_login.php',
          success:function(data){
            pageAlert('데이터를 불러오는 중');
            data = JSON.parse(data);
            if(data.status!=1){
              switch(data.status){
                case 2:
                  pageAlert('로그인에 실패 하였습니다.');
                  break;
                case 3:
                  pageAlert('로그아웃 되었습니다.');
                  break;
                case 0:
                default:
                pageAlert('알 수 없는 오류입니다.');
                  break;
              }
            }else{
              player_code = data.player_code;
              player_nickname = data.player_nickname;
              x = parseInt(data.player_x);
              y = parseInt(data.player_y);
              pageAlert('게임서버와 동기화 중');
              sync();
              setInterval(sync, 500);
            }
          },
          error:function(request,status,error){
            if(request.status==0){
              pageAlert('게임 서버에 연결할 수 없습니다.');
            }else{
              pageAlert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
          },
          complete:function(){}
        })
      }
      var canvas = document.getElementById("game");
      var ctx = canvas.getContext("2d");

      var ballRadius = 20;
      var rightPressed = false;
      var leftPressed = false;
      var upPressed = false;
      var downPressed = false;

      var x, y;
      var moveSpeed = 10;
      login();

      document.addEventListener("keydown", keyDownHandler, false);
      document.addEventListener("keyup", keyUpHandler, false);

      function keyDownHandler(e) {
          if(e.code  == "ArrowRight") {
              rightPressed = true;
          }
          else if(e.code == 'ArrowLeft') {
              leftPressed = true;
          }
          if(e.code == 'ArrowUp') {
              upPressed = true;
          }
          else if(e.code == 'ArrowDown') {
              downPressed = true;
          }
      }
      function keyUpHandler(e) {
          if(e.code  == "ArrowRight") {
              rightPressed = false;
          }
          else if(e.code == 'ArrowLeft') {
              leftPressed = false;
          }
          if(e.code == 'ArrowUp') {
              upPressed = false;
          }
          else if(e.code == 'ArrowDown') {
              downPressed = false;
          }
      }

      function drawPlayer() {
          ctx.beginPath();
          ctx.arc(x, y, ballRadius, 0, Math.PI*2);
          ctx.fillStyle = "#0095DD";
          ctx.fill();
          ctx.closePath();
      }

      function drawOtherPlayer() {
          ctx.beginPath();
          ctx.arc(x, y, ballRadius, 0, Math.PI*2);
          ctx.fillStyle = "#0095DD";
          ctx.fill();
          ctx.closePath();
      }

      function draw() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          drawPlayer();

          if(rightPressed && x < canvas.width-ballRadius-moveSpeed) {
              x += moveSpeed;
          }
          else if(leftPressed && x > ballRadius+moveSpeed) {
              x -= moveSpeed;
          }
          if(upPressed && y > ballRadius+moveSpeed) {
              y -= moveSpeed;
          }
          else if(downPressed && y < canvas.height-ballRadius-moveSpeed) {
              y += moveSpeed;
          }
      }

      function sync(){
        $.ajax({
          data:{x:x, y:y},
          type:"POST",
          url:'/game_server.php',
          success:function(data){
            data = JSON.parse(data);
            if(data.status!=1){
              switch(data.status){
                case 2:
                  pageAlert('로그인에 실패 하였습니다.');
                  break;
                case 3:
                  pageAlert('로그아웃 되었습니다.');
                  break;
                case 0:
                default:
                pageAlert('알 수 없는 오류입니다.');
                  break;
              }
            }else{
              $('.pageAlert').removeClass('on')
            }
            //x = parseInt(data.player_x);
            //y = parseInt(data.player_y);
          },
          error:function(request,status,error){
            if(request.status==0){
              pageAlert('게임서버와의 연결이 끊어졌습니다.');
            }else{
              pageAlert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
          },
          complete:function(){}
        })
      }
      setInterval(draw, 25);
    </script>
  </div>
</main>
<div class="dim menu_close"></div>
<title>betris</title>
<meta property="og:title" content="game">
<meta property="og:description" content="부산 소프트웨어 마이스터고 학교 기숙사 관리 서비스">